<?php $this->layout = "//layouts/column2_inn"; ?>
<script src="<?php echo Yii::app()->theme->baseUrl; ?>/inn/pre-inn.js"></script>
<style type="text/css">
    .fc{direction:ltr;text-align:left}.fc-rtl{text-align:right}body .fc{font-size:1em}.fc-unthemed .fc-divider,.fc-unthemed .fc-popover,.fc-unthemed .fc-row,.fc-unthemed tbody,.fc-unthemed td,.fc-unthemed th,.fc-unthemed thead{border-color:#ddd}.fc-unthemed .fc-popover{background-color:#fff}.fc-unthemed .fc-divider,.fc-unthemed .fc-popover .fc-header{background:#eee}.fc-unthemed .fc-popover .fc-header .fc-close{color:#666}.fc-unthemed .fc-today{background:#F6F3D5}.fc-highlight{background:#bce8f1;opacity:.3;filter:alpha(opacity=30)}.fc-bgevent{background:#8fdf82;opacity:.3;filter:alpha(opacity=30)}.fc-nonbusiness{background:#d7d7d7}.fc-icon{display:inline-block;width:1em;height:1em;line-height:1em;font-size:1em;text-align:center;overflow:hidden;font-family:"Courier New",Courier,monospace;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.fc-icon:after{position:relative;margin:0 -1em}.fc-icon-left-single-arrow:after{content:"\02039";font-weight:700;font-size:200%;top:-7%;left:3%}.fc-icon-right-single-arrow:after{content:"\0203A";font-weight:700;font-size:200%;top:-7%;left:-3%}.fc-icon-left-double-arrow:after{content:"\000AB";font-size:160%;top:-7%}.fc-icon-right-double-arrow:after{content:"\000BB";font-size:160%;top:-7%}.fc-icon-left-triangle:after{content:"\25C4";font-size:125%;top:3%;left:-2%}.fc-icon-right-triangle:after{content:"\25BA";font-size:125%;top:3%;left:2%}.fc-icon-down-triangle:after{content:"\25BC";font-size:125%;top:2%}.fc-icon-x:after{content:"\000D7";font-size:200%;top:6%}.fc button{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;margin:0;height:2.1em;padding:0 .6em;font-size:1em;white-space:nowrap;cursor:pointer}.fc button::-moz-focus-inner{margin:0;padding:0}.fc-state-default{border:1px solid}.fc-state-default.fc-corner-left{border-top-left-radius:4px;border-bottom-left-radius:4px}.fc-state-default.fc-corner-right{border-top-right-radius:4px;border-bottom-right-radius:4px}.fc button .fc-icon{position:relative;top:-.05em;margin:0 .2em;vertical-align:middle}.fc-state-default{background-color:#f5f5f5;background-image:-moz-linear-gradient(top,#fff,#e6e6e6);background-image:-webkit-gradient(linear,0 0,0 100%,from(#fff),to(#e6e6e6));background-image:-webkit-linear-gradient(top,#fff,#e6e6e6);background-image:-o-linear-gradient(top,#fff,#e6e6e6);background-image:linear-gradient(to bottom,#fff,#e6e6e6);background-repeat:repeat-x;border-color:#e6e6e6 #e6e6e6 #bfbfbf;border-color:rgba(0,0,0,.1) rgba(0,0,0,.1) rgba(0,0,0,.25);color:#333;text-shadow:0 1px 1px rgba(255,255,255,.75);box-shadow:inset 0 1px 0 rgba(255,255,255,.2),0 1px 2px rgba(0,0,0,.05)}.fc-state-active,.fc-state-disabled,.fc-state-down,.fc-state-hover{color:#333;background-color:#e6e6e6}.fc-state-hover{color:#333;text-decoration:none;background-position:0 -15px;-webkit-transition:background-position .1s linear;-moz-transition:background-position .1s linear;-o-transition:background-position .1s linear;transition:background-position .1s linear}.fc-state-active,.fc-state-down{background-color:#ccc;background-image:none;box-shadow:inset 0 2px 4px rgba(0,0,0,.15),0 1px 2px rgba(0,0,0,.05)}.fc-state-disabled{cursor:default;background-image:none;opacity:.65;filter:alpha(opacity=65);box-shadow:none}.fc-button-group{display:inline-block}.fc .fc-button-group>*{float:left;margin:0 0 0 -1px}.fc .fc-button-group>:first-child{margin-left:0}.fc-popover{position:absolute;box-shadow:0 2px 6px rgba(0,0,0,.15)}.fc-popover .fc-header{padding:2px 4px}.fc-popover .fc-header .fc-title{margin:0 2px}.fc-popover .fc-header .fc-close{cursor:pointer}.fc-ltr .fc-popover .fc-header .fc-title,.fc-rtl .fc-popover .fc-header .fc-close{float:left}.fc-ltr .fc-popover .fc-header .fc-close,.fc-rtl .fc-popover .fc-header .fc-title{float:right}.fc-unthemed .fc-popover{border-width:1px;border-style:solid}.fc-unthemed .fc-popover .fc-header .fc-close{font-size:.9em;margin-top:2px}.fc-popover>.ui-widget-header+.ui-widget-content{border-top:0}.fc-divider{border-style:solid;border-width:1px}hr.fc-divider{height:0;margin:0;padding:0 0 2px;border-width:1px 0}.fc-clear{clear:both}.fc-bg,.fc-bgevent-skeleton,.fc-helper-skeleton,.fc-highlight-skeleton{position:absolute;top:0;left:0;right:0}.fc-bg{bottom:0}.fc-bg table{height:100%}.fc table{width:100%;table-layout:fixed;border-collapse:collapse;border-spacing:0;font-size:1em}.fc th{text-align:center}.fc td,.fc th{border-style:solid;border-width:1px;padding:0;vertical-align:top}.fc td.fc-today{border-style:double}.fc .fc-row{border-style:solid;border-width:0}.fc-row table{border-left:0 hidden transparent;border-right:0 hidden transparent;border-bottom:0 hidden transparent}.fc-row:first-child table{border-top:0 hidden transparent}.fc-row{position:relative}.fc-row .fc-bg{z-index:1}.fc-row .fc-bgevent-skeleton,.fc-row .fc-highlight-skeleton{bottom:0}.fc-row .fc-bgevent-skeleton table,.fc-row .fc-highlight-skeleton table{height:100%}.fc-row .fc-bgevent-skeleton td,.fc-row .fc-highlight-skeleton td{border-color:transparent}.fc-row .fc-bgevent-skeleton{z-index:2}.fc-row .fc-highlight-skeleton{z-index:3}.fc-row .fc-content-skeleton{position:relative;z-index:4;padding-bottom:2px}.fc-row .fc-helper-skeleton{z-index:5}.fc-row .fc-content-skeleton td,.fc-row .fc-helper-skeleton td{background:0 0;border-color:transparent;border-bottom:0}.fc-row .fc-content-skeleton tbody td,.fc-row .fc-helper-skeleton tbody td{border-top:0}.fc-scroller{overflow-y:scroll;overflow-x:hidden}.fc-scroller>*{position:relative;width:100%;overflow:hidden}.fc-event{position:relative;display:block;font-size:.85em;line-height:1.3;border-radius:3px;border:1px solid #3a87ad;background-color:#3a87ad;font-weight:400}.fc-event,.fc-event:hover,.ui-widget .fc-event{color:#fff;text-decoration:none}.fc-event.fc-draggable,.fc-event[href]{cursor:pointer}.fc-not-allowed,.fc-not-allowed .fc-event{cursor:not-allowed}.fc-event .fc-bg{z-index:1;background:#fff;opacity:.25;filter:alpha(opacity=25)}.fc-event .fc-content{position:relative;z-index:2}.fc-event .fc-resizer{position:absolute;z-index:3}.fc-ltr .fc-h-event.fc-not-start,.fc-rtl .fc-h-event.fc-not-end{margin-left:0;border-left-width:0;padding-left:1px;border-top-left-radius:0;border-bottom-left-radius:0}.fc-ltr .fc-h-event.fc-not-end,.fc-rtl .fc-h-event.fc-not-start{margin-right:0;border-right-width:0;padding-right:1px;border-top-right-radius:0;border-bottom-right-radius:0}.fc-h-event .fc-resizer{top:-1px;bottom:-1px;left:-1px;right:-1px;width:5px}.fc-ltr .fc-h-event .fc-start-resizer,.fc-ltr .fc-h-event .fc-start-resizer:after,.fc-ltr .fc-h-event .fc-start-resizer:before,.fc-rtl .fc-h-event .fc-end-resizer,.fc-rtl .fc-h-event .fc-end-resizer:after,.fc-rtl .fc-h-event .fc-end-resizer:before{right:auto;cursor:w-resize}.fc-ltr .fc-h-event .fc-end-resizer,.fc-ltr .fc-h-event .fc-end-resizer:after,.fc-ltr .fc-h-event .fc-end-resizer:before,.fc-rtl .fc-h-event .fc-start-resizer,.fc-rtl .fc-h-event .fc-start-resizer:after,.fc-rtl .fc-h-event .fc-start-resizer:before{left:auto;cursor:e-resize}.fc-day-grid-event{margin:1px 2px 0;padding:0 1px}.fc-day-grid-event .fc-content{white-space:nowrap;overflow:hidden}.fc-day-grid-event .fc-time{font-weight:700}.fc-day-grid-event .fc-resizer{left:-3px;right:-3px;width:7px}a.fc-more{margin:1px 3px;font-size:.85em;cursor:pointer;text-decoration:none}a.fc-more:hover{text-decoration:underline}.fc-limited{display:none}.fc-day-grid .fc-row{z-index:1}.fc-more-popover{z-index:2;width:220px}.fc-more-popover .fc-event-container{padding:10px}.fc-toolbar{text-align:center;margin-bottom:1em}.fc-toolbar .fc-left{float:left}.fc-toolbar .fc-right{float:right}.fc-toolbar .fc-center{display:inline-block}.fc .fc-toolbar>*>*{float:left;margin-left:.75em}.fc .fc-toolbar>*>:first-child{margin-left:0}.fc-toolbar h2{margin:0}.fc-toolbar button{position:relative}.fc-toolbar .fc-state-hover,.fc-toolbar .ui-state-hover{z-index:2}.fc-toolbar .fc-state-down{z-index:3}.fc-toolbar .fc-state-active,.fc-toolbar .ui-state-active{z-index:4}.fc-toolbar button:focus{z-index:5}.fc-view-container *,.fc-view-container :after,.fc-view-container :before{-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box}.fc-view,.fc-view>table{position:relative;z-index:1}.fc-basicDay-view .fc-content-skeleton,.fc-basicWeek-view .fc-content-skeleton{padding-top:1px;padding-bottom:1em}.fc-basic-view .fc-body .fc-row{min-height:4em}.fc-row.fc-rigid{overflow:hidden}.fc-row.fc-rigid .fc-content-skeleton{position:absolute;top:0;left:0;right:0}.fc-basic-view .fc-day-number,.fc-basic-view .fc-week-number{padding:0 2px}.fc-basic-view td.fc-day-number,.fc-basic-view td.fc-week-number span{padding-top:2px;padding-bottom:2px}.fc-basic-view .fc-week-number{text-align:center}.fc-basic-view .fc-week-number span{display:inline-block;min-width:1.25em}.fc-ltr .fc-basic-view .fc-day-number{text-align:right}.fc-rtl .fc-basic-view .fc-day-number{text-align:left}.fc-day-number.fc-other-month{opacity:.3;filter:alpha(opacity=30)}.fc-agenda-view .fc-day-grid{position:relative;z-index:2}.fc-agenda-view .fc-day-grid .fc-row{min-height:3em}.fc-agenda-view .fc-day-grid .fc-row .fc-content-skeleton{padding-top:1px;padding-bottom:1em}.fc .fc-axis{vertical-align:middle;padding:0 4px;white-space:nowrap}.fc-ltr .fc-axis{text-align:right}.fc-rtl .fc-axis{text-align:left}.ui-widget td.fc-axis{font-weight:400}.fc-time-grid,.fc-time-grid-container{position:relative;z-index:1}.fc-time-grid{min-height:100%}.fc-time-grid table{border:0 hidden transparent}.fc-time-grid>.fc-bg{z-index:1}.fc-time-grid .fc-slats,.fc-time-grid>hr{position:relative;z-index:2}.fc-time-grid .fc-bgevent-skeleton,.fc-time-grid .fc-content-skeleton{position:absolute;top:0;left:0;right:0}.fc-time-grid .fc-bgevent-skeleton{z-index:3}.fc-time-grid .fc-highlight-skeleton{z-index:4}.fc-time-grid .fc-content-skeleton{z-index:5}.fc-time-grid .fc-helper-skeleton{z-index:6}.fc-time-grid .fc-slats td{height:1.5em;border-bottom:0}.fc-time-grid .fc-slats .fc-minor td{border-top-style:dotted}.fc-time-grid .fc-slats .ui-widget-content{background:0 0}.fc-time-grid .fc-highlight-container{position:relative}.fc-time-grid .fc-highlight{position:absolute;left:0;right:0}.fc-time-grid .fc-bgevent-container,.fc-time-grid .fc-event-container{position:relative}.fc-ltr .fc-time-grid .fc-event-container{margin:0 2.5% 0 2px}.fc-rtl .fc-time-grid .fc-event-container{margin:0 2px 0 2.5%}.fc-time-grid .fc-bgevent,.fc-time-grid .fc-event{position:absolute;z-index:1}.fc-time-grid .fc-bgevent{left:0;right:0}.fc-v-event.fc-not-start{border-top-width:0;padding-top:1px;border-top-left-radius:0;border-top-right-radius:0}.fc-v-event.fc-not-end{border-bottom-width:0;padding-bottom:1px;border-bottom-left-radius:0;border-bottom-right-radius:0}.fc-time-grid-event{overflow:hidden}.fc-time-grid-event .fc-time,.fc-time-grid-event .fc-title{padding:0 1px}.fc-time-grid-event .fc-time{font-size:.85em;white-space:nowrap}.fc-time-grid-event.fc-short .fc-content{white-space:nowrap}.fc-time-grid-event.fc-short .fc-time,.fc-time-grid-event.fc-short .fc-title{display:inline-block;vertical-align:top}.fc-time-grid-event.fc-short .fc-time span{display:none}.fc-time-grid-event.fc-short .fc-time:before{content:attr(data-start)}.fc-time-grid-event.fc-short .fc-time:after{content:"\000A0-\000A0"}.fc-time-grid-event.fc-short .fc-title{font-size:.85em;padding:0}.fc-time-grid-event .fc-resizer{left:0;right:0;bottom:0;height:8px;overflow:hidden;line-height:8px;font-size:11px;font-family:monospace;text-align:center;cursor:s-resize}.fc-time-grid-event .fc-resizer:after{content:"="}
    h2.ui.header.page-headder { padding: 10px 20px 10px }
    div.sixteen.wide.column { margin-top: 0 }
    .fc-widget-header { background: #fff }
    .fc-basic-view td.fc-day-number, .fc-basic-view td.fc-week-number span { font-size: 2em }
    .fc-event {position: relative; display: inline-block; font-size: .8em; border: 1px solid #FF007B; background-color: #FF007B;font-weight: bold; text-align: center; text-transform: uppercase}
    .fc-toolbar .fc-left h2 { text-transform: uppercase;color: #777 }
    .fc-past { color: #ccc !important }
    .fc-event, .fc-event:hover, .ui-widget .fc-event { cursor: pointer; border: 3px dotted #fff }
    .fc-day-grid-event.fc-h-event.fc-event.fc-start.fc-end { display: block }
    .ui.label.market-token { margin-bottom: 10px; border: 3px dotted #fff !important; margin: 0; }
    #home .nmpd-wrapper {display: none;}
    #home .nmpd-target {cursor: pointer;}
    #home .nmpd-grid {position:absolute; left:50px; top:50px; z-index:5000; -khtml-user-select: none; border-radius:5px; padding:10px; width: initial; background: rgba(0, 0, 0, 0.7); box-shadow: 0px 0px 4px #000}
    #home .nmpd-overlay {z-index:4999;}
    #home input.nmpd-display { text-align: right; background: transparent; border: 0; font-size: 1.5em; color: #fff; width: 100%; outline: none}
    .done.ui.button, .cancel.ui.button, .del.ui.button, .clear.ui.button { width: 106px }
    .num-header { color: #1AB8F3;text-transform: uppercase;font-size: 12.8px; font-weight: bold}
    td span.ui.orange.label.holiday {padding: 3px}
    td.fc-day.fc-widget-content.fc-future.disabled { background: #ddd }
    .ui.grid>.column { margin-top: 0}
    .sub.header { font-size: 0.85rem; font-weight: 400;margin: 0;padding: 0;line-height: 1.2;color: #F05940; text-transform: uppercase}
    .ui.buttons .or[data-text]:before { content: attr(data-text);font-weight: bold; color: red}
    .ui.popup, .ui.popup:before { background-color: #FF007B; color: #fff }
    .fc-content i.big.circle.icon { font-size: 2.5em }
    .fc-content i.big.circle.icon:hover { opacity: 1 }
</style>
<input type="hidden" id="user-pin" value="<?php echo Yii::app()->user->username; ?>"/>
<?php
$bin = implode("", array_map("chr", $this->bracUser['picture']));
$base = base64_encode($bin);
?>
<span style="display: inline-block; width: 105px; height: 130px; box-shadow: 0px 0px 3px #ccc; overflow: hidden; background: #ffffff url(data:image/png;base64,<?php echo $base; ?>) no-repeat center center; background-size: 80px;position: absolute; z-index: 999; right: 6px; border-radius: 5px; border: 3px solid #eee;"></span>
<div id="activity-controller-scope" ng-controller="ActivityController">
    <div class="ui stackable two column grid">
        <div class="column">
            <div class="ui piled segment">
                <h2 class="ui header">
                    <i class="money big teal icon"></i>
                    <div class="content">Balance<div class="sub header">হিসাবনিকাশ</div></div>
                </h2>
                <div class="ui teal label">
                    <i class="circular inverted red money icon"></i>{{balance}}<a class="detail">(BDT)</a>                             
                </div>
                =
                <div class="ui teal label">
                    <i class="circular inverted red food icon"></i>{{Math.floor(balance / unitPrice)}}
                    <a class="detail">Meal</a>
                    <i class="plus icon"></i>
                    <i class="circular inverted red money icon"></i>
                    {{balance % unitPrice| number:2}}
                    <a class="detail">(BDT)</a>
                </div>
            </div>            
        </div>
        <div class="column">
            <div class="ui ">
                <h2 class="ui header">
                    <i class="ticket big red icon"></i>
                    <div class="content">
                        Marketplace <div class="ui orange tag label">&nbsp;{{queue}}</div><div class="sub header">প্রতীক্ষমাণ কুপন</div>
                    </div>
                </h2>
                <label class="ui teal label" ng-show="queueEmpty"><i class="circular inverted red info icon"></i>No token available</label>
                <label class="ui teal label" ng-show="queueTimesup"><i class="circular inverted red info icon"></i> Marketplace is closed for today</label>
                <a ng-click="buy(qu.id)" ng-repeat="qu in market| limitTo:5" class="ui red label market-token"><i class="tag white icon"></i>T #{{ qu.id}}</a>                
                <span ng-hide="queueTimesup">
                    <hr style="color: #ccc; background: none;border: none;border-top: 1px solid #e7e7e7;" />
                    <span class="sub header">Pre Order for Token</span>
                    <div class="ui small buttons">
                        <button ng-click="userQueueRemove()" class="ui  button"><i class="minus black icon"></i></button>
                        <div class="or" id="counter" data-text="{{userQueue}}"></div>
                        <button ng-click="userQueueAdd()" class="ui positive button"><i class="plus black icon"></i></button>
                    </div>
                </span>
            </div>            
        </div>
    </div>    

    <div id="bkash-pay-help" class="ui warning icon message" style="margin-top: 0; margin-bottom: 10px">
        <div class="content">
            <div class="header">
                টাকা জমা করার জন্য আপনার বিকাশ মেনুর <i class="large red mobile icon"></i>পেমেন্ট অপসন থেকে  ০১৭০ ৯৬ ৩৩ ৭৬০ নম্বর এ পেমেন্ট করুন। <br />
                <span class="ui red ribbon label" style="margin-right: -20px">যেমন</span> *247#<i class="right arrow large  red icon"></i> 3. Payment<i class="right arrow large  red icon"></i> 01709633760<i class="right arrow large  red icon"></i> Enter amount<i class="right arrow large  red icon"></i> Reference: 1<i class="right arrow large  red icon"></i> Counter: 1<i class="right large arrow red icon"></i> Enter your PIN
            </div>    
        </div>
    </div>

    <div class="ui info icon message" style="margin-top: 0; margin-bottom: 10px">
        <div class="content">
            <div class="header">
                কুপন কিনতে নিচের ক্যালেন্ডার <i class="large red calendar icon"></i>এর নির্দিষ্ট তারিখ এ ক্লিক করুন। 
                বাতিল করার জন্য উক্ত টোকেন এর <i class="large red remove icon"></i>আইকন এ ক্লিক করুন।
                ট্রান্সফার করার জন্য উক্ত টোকেন এর<i class="right arrow large red icon"></i> আইকন এ ক্লিক করুন।
            </div>    
        </div>
    </div>
</div>

<div id='calendar'></div>

<div class="ui basic modal">
    <div class="image content" style="text-align: center">        
        <div class="description center aligned">            
            <h1 class="header"><i class="info icon huge green"></i>
                <p id="modal-message" class="green-text">You can not buy lunch token for previous days.</p>
            </h1>
        </div>
    </div>
    <div class="actions" style="text-align: center">
        <div class="ui inverted buttons">                      
            <div class="ui green basic inverted button"><i class="checkmark green icon"></i>OK</div>            
        </div>
    </div>
</div>
<input type="hidden" id="transfer-pin" value=""/>
<script type="text/javascript">
    var cal, holidays;
    var showAlertMessage = function (message) {
        $('#modal-message').html(message);
        $('.ui.basic.modal').modal({closable: false}).modal('show');
        $('.ui.dimmer.page.hidden').height($(document).height());
    }
    $.ajax({
        type: "GET", url: "/inn/holiday/index", dataType: 'json', async: false,
        success: function (data) {
            if (data)
                holidays = data;
        },
    });
    var myDesk = angular.module("myDesk", []);
    myDesk.controller('ActivityController', ['$scope', '$http', function ($scope, $http) {
            // properties
            $scope.Math = Math;
            $scope.balance;
            $scope.meal;
            $scope.money;
            $scope.market;
            $scope.queue; // q length
            $scope.userQueue; // user request from marketplace
            $scope.todayToken;
            $scope.todayQueue;
            $scope.unitPrice = 45;
            $scope.queueEmpty = false;
            $scope.queueTimesup = false;
            // init
            $scope.init = function () {
                $scope.reloadBalance();
                $scope.reloadMarket();
                $scope.reloadTokens();
                $scope.userQueueCount();
            };
            // functions
            $scope.userQueueCount = function () {
                $http.get('userQueueCount').then(function (response) {
                    if (!response.data.count)
                        $scope.userQueue = 0;
                    else
                        $scope.userQueue = response.data.count;
                }, function (response) {
                    alert("Failed to communicate with the server.");
                });
            };
            $scope.userQueueAdd = function () {
                if ($scope.balance >= (parseInt($scope.userQueue) + 1) * $scope.unitPrice) {
                    $http.get('userQueueAdd').then(
                            function (response) {
                                if (response.data.status == "success") {
                                    if (response.data.cause == "pre-queue-added") {
                                        var event = {title: "#" + response.data.id, start: response.data.date_time, id: response.data.id};
                                        $('#calendar').fullCalendar('renderEvent', event, true);
                                        showAlertMessage("You've received a new token from pre-order");
                                    } else {
                                        $scope.userQueue = parseInt($scope.userQueue) + 1;
                                    }
                                    if (response.data.balance) {
                                        $scope.balance = response.data.balance;
                                    }
                                }
                            }, function (response) {
                        alert("Failed to communicate with the server.");
                    });
                } else {
                    showAlertMessage("Insufficient balance. Please bKash money to 01709633760 <br /> কেন্টিন একাউন্ট এ টাকা জমা করার জন্য ০১৭০৯৬৩৩৭৬০ নম্বর এ বিকাশ করুন।");
                }
            };
            $scope.userQueueRemove = function () {
                if (parseInt($scope.userQueue) > 0) {
                    $http.get('userQueueRemove').then(
                            function (response) {
                                if (response.data.status == "success")
                                    $scope.userQueue = parseInt($scope.userQueue) - 1;
                            }, function (response) {
                        alert("Failed to communicate with the server.");
                    });
                }
            };
            $scope.reloadBalance = function () {
                $http.get('balance').then(function (response) {
                    $scope.balance = response.data.balance;
                }, function (response) {
                    alert("Failed to communicate with the server.");
                });
            };
            $scope.reloadMarket = function () {
                $http.get('queue').then(
                        function (response) {
                            if (response.data.status == "available") {
                                $scope.queue = response.data.queue.length;
                                $scope.market = response.data.queue;
                                $scope.queueEmpty = false;
                            } else if (response.data.status == "empty") {
                                $scope.queue = 0;
                                $scope.queueEmpty = true;
                            } else if (response.data.status == "timesup") {
                                $scope.queueTimesup = true;
                            }
                        }, function (response) {
                    alert("Failed to communicate with the server.");
                });
            };
            $scope.reloadTokens = function () {
                $http.get('alltokens').then(
                        function (response) {
                            $.each(response.data, function (i, v) {
                                var event = {title: "#" + v.id, start: v.date_time, id: v.id};
                                $('#calendar').fullCalendar('renderEvent', event, true);
                            });
                        }, function (response) {
                    alert("Failed to communicate with the server.");
                });
            };
            $scope.buy = function (serial) {
                $.ajax({
                    type: "POST", url: "buy", dataType: 'json', data: {serial: serial},
                    success: function (data) {
                        if (data) {
                            if (data.status == "success") {
                                var scope = angular.element($("#activity-controller-scope")).scope();
                                var index = scope.market.indexOf(serial);
                                scope.$apply(function () {
                                    scope.market.splice(index, 1);
                                    scope.queue = scope.queue - 1;
                                    scope.balance = data.balance;
                                });
                                var event = {title: "#" + data.id, start: data.date_time, id: data.id};
                                $('#calendar').fullCalendar('renderEvent', event, true);
                            } else if (data.status == "revert") {
                                var scope = angular.element($("#activity-controller-scope")).scope();
                                var index = scope.market.indexOf(serial);
                                scope.$apply(function () {
                                    scope.market.splice(index, 1);
                                    scope.queue = scope.queue - 1;
                                });
                                var event = {title: "#" + data.id, start: data.date_time, id: data.id};
                                $('#calendar').fullCalendar('renderEvent', event, true);
                            } else {
                                if (data.cause == "balance-problem") {
                                    showAlertMessage("You don't have enough balance to buy any token.");
                                } else if (data.cause == "not-exists") {
                                    showAlertMessage("Someone already bought this token.");
                                    var scope = angular.element($("#activity-controller-scope")).scope();
                                    var index = scope.market.indexOf(data.serial);
                                    scope.$apply(function () {
                                        scope.market.splice(index, 1);
                                        scope.queue = scope.queue - 1;
                                    });
                                }
                            }
                        }
                    },
                });
            };
            $scope.init();
        }]);
    $(document).ready(function () {
        cal = $('#calendar').fullCalendar({
            timezone: 'Asia/Dhaka',
            hiddenDays: [5, 6],
            aspectRatio: 2.5,
            fixedWeekCount: false, displayEventTime: false,
            dayClick: function (date, jsEvent, view) {
                var tCell = $(this);
                if ($(this).hasClass('disabled')) {
                    return false;
                }
                var now = moment();
                if (date.format('YY-MM-DD') < now.format('YY-MM-DD')) {
                    showAlertMessage("You can not buy lunch token for previous days.");
                } else if (date.format('YY-MM-DD') == now.format('YY-MM-DD')) {
                    showAlertMessage("Last time for booking today's token is over. You can only buy if any token available to the marketplace.");
                } else {
                    var scope = angular.element($("#activity-controller-scope")).scope();
                    if (scope.balance >= scope.unitPrice) {
                        $.ajax({
                            type: "POST", url: "create", dataType: 'json',
                            data: {pin: $('#user-pin').val(), count: 1, date_time: date.format('YYYY-MM-DD'), status: 0},
                            success: function (data) {
                                if (data && data.status == "success") {
                                    scope.$apply(function () {
                                        scope.balance = data.balance;
                                    });
                                    var event = {title: '#' + data.serial, start: date, id: data.serial};
                                    $('#calendar').fullCalendar('renderEvent', event, true);
                                    $(tCell).popup('hide all');
                                    $(tCell).popup({content : 'New Token Added', transition:'fade down', title: 'myDesk', onShow: function(){  setTimeout(function(){ $(tCell).popup('remove') }, 3000);  }}).popup('show');
                                } else {
                                    if (data.cause == 'tomorrow-time-problem') {
                                        showAlertMessage("Please book tomorrow's token before 5:30 PM today.");
                                    } else {
                                        showAlertMessage("Failed to communicate with myDesk server. Please ask for support.");
                                    }
                                }
                            }
                        });
                    } else {
                        showAlertMessage("Insufficient balance. Please bKash money to 01709633760 <br /> কেন্টিন একাউন্ট এ টাকা জমা করার জন্য ০১৭০৯৬৩৩৭৬০ নম্বর এ বিকাশ করুন।");
                    }
                }
            },
            dayRender: function (date, cell) {
                var result = $.grep(holidays, function (e) {
                    return e.holiday == date.format('YYYY-MM-DD');
                });
                //var cellPos = holidays.map(function(x) { if(x.holiday == date.format('YYYY-MM-DD')) return x; });                                            
                if (result.length > 0) {
                    $(cell).addClass('disabled');
                    $(cell).html('<span class="ui orange label holiday">' + result[0].description + '</span>');
                }
            },
            viewRender: function (view, element) {
                var now = new Date();
                var end = new Date();
                end.setMonth(now.getMonth() + 2);
                if (end < view.end) {
                    $("#calendar .fc-next-button").hide();
                    return false;
                } else
                    $("#calendar .fc-next-button").show();
                if (view.start < now) {
                    $("#calendar .fc-prev-button").hide();
                    return false;
                } else
                    $("#calendar .fc-prev-button").show();
            },
            eventRender: function (event, element) {
                element.find('.fc-content').prepend("<span class='closeon'><i  title='Cancel Token' class='remove big circle icon'></i></span>");
                element.find('.fc-content').append("<span class='trnasfer'><i title='Transfer Token' class='arrow big circle right icon' style='margin-right:5px'></i></span>");
                element.find(".closeon").click(function () {
                    var r = confirm("Do you really want to CANCEL Token #" + event.id + " ?");
                    if (r == true) {
                        $.ajax({
                            type: "POST", url: "cancel", dataType: 'json', data: {serial: event.id},
                            success: function (data) {
                                if (data) {
                                    var scope = angular.element($("#activity-controller-scope")).scope();
                                    if (data.status == "success") {
                                        if (data.cause == "marketplace") {
                                            cal.fullCalendar('removeEvents', event.id);
                                            scope.reloadMarket();
                                            showAlertMessage("Your token sent to marketplace. If someone buy that for today, you'll get refund.");
                                        } else {
                                            scope.$apply(function () {
                                                scope.balance = data.balance;
                                            });
                                            cal.fullCalendar('removeEvents', event.id);
                                        }
                                    } else {
                                        if (data.cause == "time-up") {
                                            showAlertMessage("Sorry! The last time for canceling todays token is 2:30 PM");
                                        }
                                    }
                                }
                            },
                        });
                    }
                });
                element.find(".trnasfer").numpad({
                    target: $('#transfer-pin'),
                    hidePlusMinusButton: true,
                    hideDecimalButton: true,
                    onKeypadOpen: function () {
                        $('#transfer-pin').val('');
                        $(this).find('.nmpd-display').val('').focus();
                    },
                    onChange: function (event, value) {
                        $(this).find('.nmpd-display').focus();
                    },
                    onKeypadClose: function () {
                        if ($('#transfer-pin').val() != "") {
                            var r = confirm("Do you really want to TRANSFER Token #" + event.id + " to PIN " + $('#transfer-pin').val() + " ?");
                            if (r == true) {
                                $.ajax({
                                    type: "POST", url: "transfer", dataType: 'json', data: {serial: event.id, to_pin: $('#transfer-pin').val()},
                                    success: function (data) {
                                        if (data) {
                                            if (data.status == "success") {
                                                $('#calendar').fullCalendar('removeEvents', event.id);
                                                showAlertMessage("Token #" + data.serial + " successfully transfered to " + $('#transfer-pin').val());
                                            } else {
                                                if (data.cause == "time-up") {
                                                    showAlertMessage("You can only transfer todays token before 2:30PM.");
                                                } else if (data.cause == "invalid-pin") {
                                                    showAlertMessage($('#transfer-pin').val() + " is not seems to be a valid BRAC PIN.");
                                                } else if (data.cause == "same-pin") {
                                                    showAlertMessage("You cannot transfer your token to yourself.");
                                                } else if (data.cause == "not-found") {
                                                    showAlertMessage("Token not available on the system. Please refresh the application.");
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                        }
                    }
                });
            }
        });
    });
</script>